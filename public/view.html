<!DOCTYPE html>
<html>
<head>
    <title>æ–‡ä»¶é˜…è§ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
</head>
<body>
    <div class="container">
        
        <!-- æ­¥éª¤1: éªŒè¯ç  -->
        <div id="auth-step" class="glass-card" style="max-width:400px; margin:0 auto;">
            <h2>èº«ä»½éªŒè¯</h2>
            <input type="text" id="code" placeholder="è¯·è¾“å…¥æ¿€æ´»ç ">
            <button onclick="doVerify()">éªŒè¯è¿›å…¥</button>
        </div>

        <!-- æ­¥éª¤2: æ–‡ä»¶ç›®å½• -->
        <div id="list-step" class="glass-card" style="display:none;">
            <div style="display:flex; justify-content:space-between;">
                <h2>æ–‡ä»¶åˆ—è¡¨</h2>
                <button onclick="logout()" style="width:auto; padding:5px 15px; font-size:12px; height:30px; background:#ef4444;">é€€å‡º</button>
            </div>
            <ul id="file-ul" class="file-list"></ul>
        </div>

        <!-- æ­¥éª¤3: PDF é˜…è¯»å™¨ -->
        <div id="reader-step" class="glass-card" style="display:none; padding:10px;">
            <button onclick="backToList()" style="margin-bottom:10px; background:#6b7280;">&larr; è¿”å›ç›®å½•</button>
            <div id="pdf-wrapper">
                <div id="canvases"></div>
                <div id="watermarks" class="watermark"></div>
                <div class="overlay" oncontextmenu="return false;"></div> <!-- é˜»æŒ¡å³é”® -->
            </div>
        </div>

    </div>

    <script>
        let currentCode = '';

        async function doVerify() {
            const code = document.getElementById('code').value;
            const res = await fetch(`/api/verify?code=${code}`);
            const data = await res.json();
            
            if (data.valid) {
                currentCode = code;
                document.getElementById('auth-step').style.display = 'none';
                loadFileList();
            } else {
                alert('æ¿€æ´»ç æ— æ•ˆæˆ–å·²è¿‡æœŸ');
            }
        }

        async function loadFileList() {
            // é€šè¿‡ API è·å–æ–‡ä»¶åˆ—è¡¨ (ä»£ç† PHP)
            const res = await fetch(`/api/file-proxy?action=list&code=${currentCode}`);
            if(!res.ok) return alert('æ— æ³•åŠ è½½ç›®å½•');
            
            const files = await res.json();
            const ul = document.getElementById('file-ul');
            ul.innerHTML = '';
            
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `<span class="file-icon">ğŸ“„</span> ${file}`;
                li.onclick = () => openFile(file);
                ul.appendChild(li);
            });
            
            document.getElementById('list-step').style.display = 'block';
        }

        async function openFile(filename) {
            document.getElementById('list-step').style.display = 'none';
            document.getElementById('reader-step').style.display = 'block';
            document.getElementById('canvases').innerHTML = 'æ­£åœ¨åŠ è½½å®‰å…¨æ–‡æ¡£...';
            
            // è¯·æ±‚æ–‡ä»¶æµ
            const url = `/api/file-proxy?action=get&file=${filename}&code=${currentCode}`;
            
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                document.getElementById('canvases').innerHTML = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: context, viewport: viewport}).promise;
                    document.getElementById('canvases').appendChild(canvas);
                }
                
                // åŠ æ°´å°
                addWatermark();
            } catch(e) {
                alert('åŠ è½½å¤±è´¥');
                backToList();
            }
        }

        function addWatermark() {
            const container = document.getElementById('watermarks');
            container.innerHTML = '';
            for(let i=0; i<30; i++) {
                const div = document.createElement('div');
                div.className = 'wm-text';
                div.innerText = `æœºå¯† - ${currentCode} - ${new Date().toLocaleDateString()}`;
                container.appendChild(div);
            }
        }

        function backToList() {
            document.getElementById('reader-step').style.display = 'none';
            document.getElementById('list-step').style.display = 'block';
        }
        
        function logout() { location.reload(); }

        // å±è”½æŒ‰é”®
        document.onkeydown = function(e) {
            if(e.keyCode == 123 || (e.ctrlKey && (e.key === 'p' || e.key === 's'))) return false;
        }
    </script>
</body>
</html>

<script>
    // åŠ¨æ€åŠ è½½èƒŒæ™¯å›¾ï¼šå°è¯• /api/bing-bgï¼Œå¤±è´¥åˆ™å›é€€åˆ°æ¸å˜
    (function(){
        const img = new Image();
        img.onload = function(){
            document.body.style.background = "linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)), url('/api/bing-bg') center/cover no-repeat fixed";
        };
        img.onerror = function(){
            document.body.style.background = 'linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(236,72,153,0.15) 100%)';
        };
        img.src = '/api/bing-bg';
    })();
</script>