<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>管理后台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <style>
        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background:#fef3c7; color:#d97706; }
        .status-approved { background:#d1fae5; color:#059669; }
        .status-rejected { background:#fee2e2; color:#dc2626; }

        .btn-approve {
            background:#10b981;
            padding:6px 12px;
            font-size:12px;
            width:auto;
            margin-right:5px;
        }
        .btn-reject {
            background:#ef4444;
            padding:6px 12px;
            font-size:12px;
            width:auto;
        }
    </style>

    <!-- ✅ 关键：API 实际部署地址 -->
    <script>
        const API_BASE = 'https://betteryuan.cn/api';
        // ↑↑↑ 如果你的 API 域名不是这个，只改这一行
    </script>
</head>

<body>
<div class="container">

    <!-- 登录 -->
    <div class="glass-card" id="login-box">
        <h2>管理员登录</h2>
        <input type="password" id="pwd" placeholder="输入管理密码">
        <button onclick="login()">登录</button>
    </div>

    <!-- 后台 -->
    <div class="glass-card" id="admin-box" style="display:none; max-width:1100px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>申请审批列表</h2>
            <button onclick="logout()" style="width:auto;background:#666;font-size:14px;padding:8px 16px;">
                刷新 / 退出
            </button>
        </div>

        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;text-align:left;">
                <thead>
                <tr style="border-bottom:2px solid rgba(0,0,0,0.05);color:#666;">
                    <th>ID</th>
                    <th>姓名</th>
                    <th>邮箱</th>
                    <th>状态</th>
                    <th>拒绝原因 / 激活码</th>
                    <th style="text-align:right;">操作</th>
                </tr>
                </thead>
                <tbody id="list"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
let token = '';

/* 登录 */
async function login() {
    const pwd = document.getElementById('pwd').value;

    const res = await fetch(API_BASE + '/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: pwd })
    });

    if (!res.ok) {
        alert('密码错误');
        return;
    }

    const data = await res.json();
    token = data.token;

    document.getElementById('login-box').style.display = 'none';
    document.getElementById('admin-box').style.display = 'block';

    loadData();
}

/* 加载数据 */
async function loadData() {
    const res = await fetch(API_BASE + '/admin-data', {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    });

    if (!res.ok) {
        alert('登录已失效');
        logout();
        return;
    }

    const data = await res.json();
    const tbody = document.getElementById('list');
    tbody.innerHTML = '';

    data.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid rgba(0,0,0,0.05)';

        let info = '-';
        if (item.status === 'approved') info = item.activation_code || '-';
        if (item.status === 'rejected') {
            info = `<span style="color:#ef4444;font-size:12px;">
                ${item.reject_reason || '无'}
            </span>`;
        }

        tr.innerHTML = `
            <td>#${item.id}</td>
            <td>${item.name}</td>
            <td>${item.contact}</td>
            <td>
                <span class="status-badge status-${item.status}">
                    ${item.status.toUpperCase()}
                </span>
            </td>
            <td>${info}</td>
            <td style="text-align:right;">
                ${item.status === 'pending' ? `
                    <button class="btn-approve" onclick="approve(${item.id})">通过</button>
                    <button class="btn-reject" onclick="reject(${item.id})">拒绝</button>
                ` : '<span style="color:#aaa;font-size:12px;">已处理</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* 通过 */
async function approve(id) {
    if (!confirm('确认通过并发送激活码？')) return;

    const res = await fetch(API_BASE + '/approve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ id })
    });

    const data = await res.json();

    if (!res.ok) {
        alert('失败：' + data.error);
        return;
    }

    alert('已通过，激活码邮件已发送');
    loadData();
}

/* 拒绝 */
async function reject(id) {
    const reason = prompt('请输入拒绝原因：');
    if (!reason) return;

    const res = await fetch(API_BASE + '/reject', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ id, reason })
    });

    const data = await res.json();

    if (!res.ok) {
        alert('失败：' + data.error);
        return;
    }

    alert('已拒绝，通知邮件已发送');
    loadData();
}

/* 退出 */
function logout() {
    token = '';
    location.reload();
}
</script>

<script>
/* 背景图 */
(function(){
    const img = new Image();
    img.onload = () => {
        document.body.style.background =
            "linear-gradient(rgba(0,0,0,.4),rgba(0,0,0,.2)),url('" +
            API_BASE.replace('/api','') +
            "/api/bing-bg') center/cover no-repeat fixed";
    };
    img.onerror = () => {
        document.body.style.background =
            "linear-gradient(135deg, rgba(99,102,241,.15), rgba(236,72,153,.15))";
    };
    img.src = API_BASE.replace('/api','') + '/api/bing-bg';
})();
</script>

</body>
</html>
