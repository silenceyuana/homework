<!DOCTYPE html>
<html>
<head>
    <title>ç®¡ç†åå°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <!-- é¢„å…ˆå»ºç«‹è¿æ¥ï¼ŒåŠ å¿« API å“åº” -->
<link rel="preconnect" href="https://www.bing.com">
<!-- å°è¯•é¢„åŠ è½½èƒŒæ™¯å›¾ (æµè§ˆå™¨æ”¯æŒç¨‹åº¦ä¸åŒï¼Œä¸ä¸€å®šå®Œå…¨ç”Ÿæ•ˆï¼Œä½†æœ‰å¥½å¤„) -->
<link rel="preload" as="image" href="/api/bing-bg">
    <style>
        /* å¢åŠ ä¸€äº›åå°ç‰¹æœ‰çš„æ ·å¼ */
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-approved { background: #d1fae5; color: #059669; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .status-used { background: #e5e7eb; color: #6b7280; }
        
        .btn-approve { background: #10b981; padding: 6px 12px; font-size: 12px; width: auto; display: inline-block; margin-right: 5px; }
        .btn-reject { background: #ef4444; padding: 6px 12px; font-size: 12px; width: auto; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•éƒ¨åˆ†ä¿æŒä¸å˜ -->
        <div class="glass-card" id="login-box">
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="password" id="pwd" placeholder="è¾“å…¥ç®¡ç†å¯†ç ">
            <button onclick="login()">ç™»å½•</button>
        </div>

        <!-- æ•°æ®åˆ—è¡¨éƒ¨åˆ† -->
        <div class="glass-card" id="admin-box" style="display:none; max-width:1100px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
                <h2>ç”³è¯·å®¡æ‰¹åˆ—è¡¨</h2>
                <button onclick="location.reload()" style="width:auto; background:#666; font-size: 14px; padding: 8px 16px;">åˆ·æ–° / é€€å‡º</button>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:2px solid rgba(0,0,0,0.05); color: #666;">
                            <th style="padding:10px;">ID</th>
                            <th>å§“å</th>
                            <th>é‚®ç®±</th>
                            <th>çŠ¶æ€</th>
                            <th>æ‹’ç»åŸå› /æ¿€æ´»ç </th>
                            <th style="text-align:right;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let token = '';

        async function login() {
            const pwd = document.getElementById('pwd').value;
            const res = await fetch('/api/login', {
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({password: pwd})
            });
            if(res.ok) {
                const data = await res.json();
                token = data.token;
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('admin-box').style.display = 'block';
                loadData();
            } else {
                alert('å¯†ç é”™è¯¯');
            }
        }

        async function loadData() {
            const res = await fetch('/api/admin-data', {
                headers: { 'Authorization': token }
            });
            const data = await res.json();
            const tbody = document.getElementById('list');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(0,0,0,0.05)';
                
                // çŠ¶æ€æ ‡ç­¾
                let statusClass = `status-${item.status}`;
                let infoText = item.activation_code || '-';
                if(item.status === 'rejected') infoText = `<span style="color:#ef4444; font-size:12px;">${item.reject_reason || 'æ— åŸå› '}</span>`;

                tr.innerHTML = `
                    <td style="padding:15px 10px;">#${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.contact}</td>
                    <td><span class="status-badge ${statusClass}">${item.status.toUpperCase()}</span></td>
                    <td>${infoText}</td>
                    <td style="text-align:right;">
                        ${item.status === 'pending' ? `
                            <button class="btn-approve" onclick="approve(${item.id})">é€šè¿‡</button>
                            <button class="btn-reject" onclick="reject(${item.id})">æ‹’ç»</button>
                        ` : '<span style="color:#aaa; font-size:12px;">å·²å¤„ç†</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // é€šè¿‡
        async function approve(id) {
            if(!confirm('ç¡®è®¤é€šè¿‡è¯¥ç”³è¯·å¹¶å‘é€æ¿€æ´»ç é‚®ä»¶ï¼Ÿ')) return;
            
            // UI åé¦ˆ
            showLoading(true);

            const res = await fetch('/api/approve', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization': token},
                body: JSON.stringify({id})
            });
            
            showLoading(false);
            
            if(res.ok) { 
                alert('âœ… å·²é€šè¿‡ï¼Œé‚®ä»¶å‘é€æˆåŠŸï¼'); 
                loadData(); 
            } else { 
                alert('âŒ å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Resend é…ç½®æˆ–æ—¥å¿—'); 
            }
        }

        // æ‹’ç»
        async function reject(id) {
            const reason = prompt("è¯·è¾“å…¥æ‹’ç»åŸå›  (å°†å‘é€ç»™ç”¨æˆ·):", "èµ„æ–™ä¸å®Œæ•´ï¼Œè¯·è¡¥å……åé‡æ–°ç”³è¯·ã€‚");
            if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
            if (reason.trim() === "") return alert("å¿…é¡»å¡«å†™æ‹’ç»åŸå› ");

            showLoading(true);

            const res = await fetch('/api/reject', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization': token},
                body: JSON.stringify({ id, reason })
            });

            showLoading(false);

            if(res.ok) { 
                alert('ğŸš« å·²æ‹’ç»ï¼Œé€šçŸ¥é‚®ä»¶å‘é€æˆåŠŸï¼'); 
                loadData(); 
            } else { 
                alert('âŒ æ“ä½œå¤±è´¥'); 
            }
        }

        function showLoading(isLoading) {
            // ç®€å•çš„å…¨å±€ loading é®ç½©
            if(isLoading) {
                const div = document.createElement('div');
                div.id = 'loading-mask';
                div.style = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.5); z-index:999; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(5px);';
                div.innerHTML = '<div style="background:white; padding:20px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">é‚®ä»¶å‘é€ä¸­...</div>';
                document.body.appendChild(div);
            } else {
                const div = document.getElementById('loading-mask');
                if(div) div.remove();
            }
        }
    </script>
    <script>
        // åŠ¨æ€åŠ è½½èƒŒæ™¯å›¾ï¼šä¼˜å…ˆå°è¯•ä» /api/bing-bg åŠ è½½å›¾ç‰‡ï¼Œå¤±è´¥åˆ™ä½¿ç”¨æ¸å˜ä½œä¸ºå›é€€
        (function(){
            const img = new Image();
            img.onload = function(){
                document.body.style.background = "linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)), url('/api/bing-bg') center/cover no-repeat fixed";
            };
            img.onerror = function(){
                // å›é€€ï¼šä»…æ¸å˜èƒŒæ™¯ï¼Œç¡®ä¿åœ¨æ²¡æœ‰åç«¯æˆ–æ‰“å¼€ä¸º file:// æ—¶ä¹Ÿæœ‰è‰¯å¥½å±•ç¤º
                document.body.style.background = 'linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(236,72,153,0.15) 100%)';
            };
            // è§¦å‘åŠ è½½
            img.src = '/api/bing-bg';
        })();
    </script>
</body>
</html>